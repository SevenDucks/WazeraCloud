<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui"
    xmlns:pe="http://primefaces.org/ui/extensions"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
    xmlns:s="http://java.sun.com/jsf/composite/components/shared"
	xmlns:tw="http://java.sun.com/jsf/composite/components/tasks"
    template="/templates/default.xhtml">
    
    <ui:define name="center">

		<script type="text/javascript">
		
			function saveScrollPos() {
				sessionStorage.scrollTop = $('#documentMenuForm\\:treePanel').scrollTop();
			}

			function loadScrollPos() {
				$('#documentMenuForm\\:treePanel').scrollTop(sessionStorage.scrollTop);
			}
			
			function resetScrollPos() {
				$('#documentMenuForm\\:treePanel').scrollTop(0);
			}

			function searchKeyPress(e) {
			    if (e.keyCode == 13) {
			        updateTree();
			    }
			}
			
			function bindSaveKey() {
				$('.ql-editor').keydown(function (e) {
				    if (e.keyCode == 83 &amp;&amp; event.ctrlKey) {
			        	e.preventDefault();
			        	saveDocument();
				    }
				});
			}

			$(document).ready(function () {
				setTimeout(updateTree, 250);
			});
			
			$(window).on('resize', function() {
				setTimeout(resizeTreePanel, 250);
				setTimeout(resizeEditor, 250);
			});

			function resizeTreePanel() {
				var searchHeight = $("#documentMenuForm\\:searchTags > .ui-chips-container").height();
				$("#documentMenuForm\\:treePanel").height($(document).height() - 68 - searchHeight);
			}
			
			function resizeEditor() {
				var buttonBarHeight = $("#mainForm\\:buttonBar").height();
				var newHeight = $(document).height() - buttonBarHeight;
				
				var dashboardHeader = $("#mainForm\\:dashboardHeader");
				$("#mainForm\\:dashboardPanel").height($(document).height() - dashboardHeader.outerHeight() - 40);
				
				var navigatorHeader = $("#mainForm\\:navigatorHeader");
				$("#mainForm\\:navigatorPanel").height($(document).height() - navigatorHeader.outerHeight() - 40);
				
				var openToolbar = $("#mainForm\\:editorOpen_toolbar");
				$("#mainForm\\:editorOpen_editor").height(newHeight - openToolbar.outerHeight() - 46);
				var closedToolbar = $("#mainForm\\:editorClosed_toolbar");
				$("#mainForm\\:editorClosed_editor").height(newHeight - closedToolbar.outerHeight() - 46);
				
				var workflowHeader = $("#mainForm\\:workflowHeader");
				$("#mainForm\\:workflowPanel").height(newHeight - workflowHeader.outerHeight() - 57);
			}
			
		</script>

		<p:layout>
		
			<p:layoutUnit
				id="layoutUnitWest"
				position="west"
				gutter="0"
				size="360"
				styleClass="no-border no-overflow gray-bg"
				style="padding: 3px;">

				<h:form id="documentMenuForm">

					<p:chips
						id="searchTags"
						value="#{docsController.searchTags}"
						placeholder="Search for Document Names or Tags..."
						disabled="#{docsController.allowEditing || docsController.allowSorting}"
						onkeyup="searchKeyPress(event)"
						styleClass="search-container"
						style="width: calc(100% - 2px); height: 23px; color: #ffffff;">
						<p:ajax
							event="itemUnselect"
							oncomplete="updateTree()"/>
					</p:chips>
					<p:selectBooleanButton
						id="buttonToggleSort"
						value="#{docsController.allowSorting}"
						disabled="#{docsController.disableToggleSorting}"
						onLabel="Leave Sort Mode"
						offLabel="Enter Sort Mode"
						onIcon="ui-icon-close"
						offIcon="ui-icon-caret-2-n-s"
						style="width: 132px; height: 21px; margin: 0;">
						<p:ajax
							update="documentTree searchTags buttonSearch"
							oncomplete="resizeTreePanel(); resetScrollPos();"/>
					</p:selectBooleanButton>
		        	<p:commandButton
		        		id="buttonRefresh"
			        	value="Refresh"
			        	icon="ui-icon-arrowrefresh-1-e"
			        	disabled="#{docsController.allowEditing}"
			        	actionListener="#{docsController.selectTree}"
			        	update=":documentMenuForm :mainForm"
			        	onstart="saveScrollPos();"
			        	oncomplete="resizeTreePanel(); resizeEditor(); loadScrollPos();"
			        	style="width: 110px; height: 23px; margin: 0;"/>
					<p:commandButton
						id="buttonSearch"
						value="Search"
			        	icon="ui-icon-search"
						disabled="#{docsController.allowEditing || docsController.allowSorting}"
						onclick="updateTree()"
						style="width: 110px; height: 23px; margin: 0;"/>
					<p:remoteCommand
						name="updateTree"
						actionListener="#{docsController.selectTree}"
						update="buttonToggleSort documentTree :mainForm"
						oncomplete="resizeTreePanel(); resizeEditor();"/>
					<p:remoteCommand
						name="updateAll"
						actionListener="#{docsController.selectTree}"
						update="searchTags buttonToggleSort buttonRefresh buttonSearch documentTree :mainForm"
						oncomplete="resizeTreePanel(); resizeEditor();"/>
					
					<p:scrollPanel
						id="treePanel"
						mode="native"
						styleClass="gray-bg-dark"
						style="width: calc(100% - 2px); height: 300px; overflow: scroll;">

						<p:tree
							id="documentTree"
							cache="false"
							value="#{docsController.documentTree}"
							var="node"
							styleClass="no-border inherit-tree-overflow gray-bg-dark"
							style="width: 100%; height: 100%;"
							selectionMode="single"
							selection="#{docsController.selectedNode}"
							dynamic="true"
							disabled="#{docsController.allowEditing}"
							draggable="#{docsController.allowSorting}"
							droppable="#{docsController.allowSorting}">
	
					        <p:treeNode
					        	id="rootNode"
					        	type="rootNode"
					        	styleClass="rootNode">
					        	<h:panelGrid
					        		columns="3">
					        		<h:outputLink
					        			styleClass="new-tab"
					        			value="#{docsController.getDocumentLink(node.node)}"
					        			target="_blank"
					        			onclick="event.stopPropagation();">
					        			&#x1F5D7;
					        		</h:outputLink>
					            	<p:outputLabel styleClass="#{node.type.icon}"/>
					            	<h:outputText value="#{node.name}"/>
					        	</h:panelGrid>
					        </p:treeNode>
	
					        <p:treeNode
					        	id="directoryNode"
					        	type="directoryNode"
					        	styleClass="directoryNode">
					        	<h:panelGrid
					        		columns="3">
					        		<h:outputLink
					        			styleClass="new-tab"
					        			value="#{docsController.getDocumentLink(node.node)}"
					        			target="_blank"
					        			onclick="event.stopPropagation();">
					        			&#x1F5D7;
					        		</h:outputLink>
					            	<p:outputLabel styleClass="#{node.type.icon}"/>
					            	<h:outputText value="#{node.name}"/>
					        	</h:panelGrid>
					        </p:treeNode>
	
					        <p:treeNode
					        	id="documentNode"
					        	type="documentNode"
					        	styleClass="documentNode">
					        	<h:panelGrid
					        		columns="3">
					        		<h:outputLink
					        			styleClass="new-tab"
					        			value="#{docsController.getDocumentLink(node.node)}"
					        			target="_blank"
					        			onclick="event.stopPropagation();">
					        			&#x1F5D7;
					        		</h:outputLink>
					            	<p:outputLabel styleClass="#{node.type.icon}"/>
					            	<h:outputText value="#{node.name}"/>
					        	</h:panelGrid>
					        </p:treeNode>
					        
					        <p:treeNode
					        	id="workflowNode"
					        	type="workflowNode"
					        	styleClass="workflowNode">
					        	<h:panelGrid
					        		columns="3">
					        		<h:outputLink
					        			styleClass="new-tab"
					        			value="#{docsController.getDocumentLink(node.node)}"
					        			target="_blank"
					        			onclick="event.stopPropagation();">
					        			&#x1F5D7;
					        		</h:outputLink>
					            	<p:outputLabel styleClass="#{node.type.icon}"/>
					            	<h:outputText value="#{node.name}"/>
					        	</h:panelGrid>
					        </p:treeNode>
	
					        <p:ajax event="select" update=":documentMenuForm :mainForm" onstart="saveScrollPos();" oncomplete="resizeTreePanel(); resizeEditor(); loadScrollPos();"/>
					        <p:ajax event="contextMenu" update=":mainForm" oncomplete="resizeEditor();"/>
					        <p:ajax event="dragdrop" listener="#{docsController.onDragDrop}" update=":documentMenuForm" onstart="saveScrollPos();" oncomplete="resizeTreePanel(); loadScrollPos();"/>
						    <p:ajax event="expand" listener="#{docsController.onNodeExpand}"/>
							<p:ajax event="collapse" listener="#{docsController.onNodeCollapse}"/>
					    </p:tree>
				    
				    </p:scrollPanel>

					<!--
					<p:menuitem
       					value="Open in New Tab"
      						icon="fa fa-external-link"
       					update="documentLinkPanel"
       					oncomplete="openDocumentLink();"/>
					-->
					<p:contextMenu for="documentTree" nodeType="rootNode" widgetVar="rootNodeMenu">
			            <p:menuitem
			            	value="Collapse All"
			            	icon="fa fa-folder"
			            	actionListener="#{docsController.collapseAll()}"
			            	update="documentTree :mainForm"/>
			            <p:menuitem
			            	value="New Folder"
			            	icon="fa fa-folder-open"
			            	disabled="#{!docsController.canEditFolders()}"
			            	actionListener="#{docsController.setName('New Folder')}"
			            	onclick="PF('dialogAddDirectory').show();"
			            	update=":addDirectoryDialogForm"/>
			            <p:menuitem
			            	value="New Document"
			            	icon="fa fa-file"
			            	disabled="#{!docsController.canEditDocuments()}"
			            	actionListener="#{docsController.setName('New Document')}"
			            	onclick="PF('dialogAddDocument').show();"
			            	update=":addDocumentDialogForm"/>
		            	<p:menuitem
			            	value="New Workflow"
			            	icon="fa fa-share-alt"
			            	disabled="#{!docsController.canEditWorkflows()}"
			            	actionListener="#{docsController.setName('New Workflow', 'workflowNode')}"
			            	onclick="PF('dialogAddDocument').show();"
			            	update=":addDocumentDialogForm"/>
				    </p:contextMenu>

					<!--
					<p:menuitem
       					value="Open in New Tab"
      						icon="fa fa-external-link"
       					update="documentLinkPanel"
       					oncomplete="openDocumentLink();"/>
					-->
					<p:contextMenu for="documentTree" nodeType="directoryNode" widgetVar="directoryNodeMenu">
						<p:menuitem
							value="Collapse All"
							icon="fa fa-folder"
							actionListener="#{docsController.collapseRecursive(docsController.selectedNode)}"
							update="documentTree :mainForm"/>
			            <p:menuitem
			            	value="New Folder"
			            	icon="fa fa-folder-open"
			            	disabled="#{!docsController.canEditFolders()}"
			            	actionListener="#{docsController.setName('New Folder')}"
			            	onclick="PF('dialogAddDirectory').show();"
			            	update=":addDirectoryDialogForm"/>
			            <p:menuitem
			            	value="New Document"
			            	icon="fa fa-file"
			            	disabled="#{!docsController.canEditDocuments()}"
			            	actionListener="#{docsController.setName('New Document', 'documentNode')}"
			            	onclick="PF('dialogAddDocument').show();"
			            	update=":addDocumentDialogForm"/>
			            <p:menuitem
			            	value="New Workflow"
			            	icon="fa fa-share-alt"
			            	disabled="#{!docsController.canEditWorkflows()}"
			            	actionListener="#{docsController.setName('New Workflow', 'workflowNode')}"
			            	onclick="PF('dialogAddDocument').show();"
			            	update=":addDocumentDialogForm"/>
	       				<p:menuitem
	       					value="Rename"
	       					icon="fa fa-refresh"
	       					disabled="#{!docsController.canEditFolders()}"
	       					onclick="PF('dialogRenameDirectory').show();"
	       					update=":renameDirectoryDialogForm"/>
	       				<p:menuitem
	       					value="Delete"
	       					icon="fa fa-trash"
	       					disabled="#{!docsController.canDeleteFolders()}"
	       					actionListener="#{docsController.deleteFolder}"
	       					update="documentTree :mainForm"
	       					onstart="saveScrollPos()"
							oncomplete="resizeEditor(); resizeTreePanel(); loadScrollPos();">
	       					<p:confirm header="Confirm" message="Delete Folder?" icon="ui-icon-alert"/>
	       				</p:menuitem>
				    </p:contextMenu>
				    
					<!--
					<p:menuitem
       					value="Open in New Tab"
      						icon="fa fa-external-link"
       					update="documentLinkPanel"
       					oncomplete="openDocumentLink();"/>
					-->
					<p:contextMenu for="documentTree" nodeType="documentNode" widgetVar="documentNodeMenu">
	       				<p:menuitem
			            	value="Copy"
			            	icon="fa fa-copy"
			            	disabled="#{!docsController.canEditDocuments()}"
			            	actionListener="#{docsController.setName(docsController.name.concat(' - Copy'))}"
			            	onclick="PF('dialogCopyDocument').show();"
			            	update=":copyDocumentDialogForm"/>
	       				<p:menuitem
	       					value="Rename"
       						icon="fa fa-refresh"
       						disabled="#{!docsController.canEditDocuments()}"
	       					onclick="PF('dialogRenameDocument').show();"
	       					update=":renameDocumentDialogForm"/>
	       				<p:menuitem
	       					value="Delete"
	       					icon="fa fa-trash"
	       					disabled="#{!docsController.canDeleteDocuments()}"
	       					actionListener="#{docsController.deleteDocument}"
	       					update="documentTree :mainForm"
	       					onstart="saveScrollPos()"
							oncomplete="resizeEditor(); resizeTreePanel(); loadScrollPos();">
	       					<p:confirm header="Confirm" message="Delete Element?" icon="ui-icon-alert"/>
	       				</p:menuitem>
				    </p:contextMenu>
				    
					<!--
					<p:menuitem
       					value="Open in New Tab"
      						icon="fa fa-external-link"
       					update="documentLinkPanel"
       					oncomplete="openDocumentLink();"/>
					-->
				    <p:contextMenu for="documentTree" nodeType="workflowNode" widgetVar="workflowNode">
	       				<p:menuitem
	       					value="Rename"
       						icon="fa fa-refresh"
       						disabled="#{!docsController.canEditWorkflows()}"
	       					onclick="PF('dialogRenameDocument').show();"
	       					update=":renameDocumentDialogForm"/>
	       				<p:menuitem
	       					value="Delete"
	       					icon="fa fa-trash"
	       					disabled="#{!docsController.canDeleteWorkflows()}"
	       					actionListener="#{docsController.deleteDocument}"
	       					update="documentTree :mainForm"
	       					onstart="saveScrollPos()"
							oncomplete="resizeEditor(); resizeTreePanel(); loadScrollPos();">
	       					<p:confirm header="Confirm" message="Delete Document?" icon="ui-icon-alert"/>
	       				</p:menuitem>
				    </p:contextMenu>

				</h:form>
				
				<p:panel id="documentLinkPanel">
					<script type="text/javascript">
	
						function openDocumentLink() {
							window.open('#{docsController.getDocumentLink()}', '_blank');
							window.open().close();
						}
		
					</script>
				</p:panel>

			</p:layoutUnit>

			<p:layoutUnit
				id="center"
				position="center"
				gutter="0"
				size="100%"
				styleClass="no-border no-overflow gray-bg"
				style="padding: 3px;">

				<h:form id="mainForm">
				
					<p:outputPanel rendered="#{docsController.showDashboard()}">
					
						<p:outputPanel id="dashboardHeader" styleClass="editor-header">
							<h2 class="no-spacing">Dashboard</h2>
							<p class="no-spacing" style="color: #888888;">
								Welcome to the <b style="font-weight: 800;">Wazera Cloud</b>!
							</p>
							<p:breadCrumb model="#{docsController.breadcrumbModel}" homeDisplay="text"/>
						</p:outputPanel>
						<p:scrollPanel
							id="dashboardPanel"
							mode="native"
							styleClass="gray-bg"
							style="width: calc(100% - 2px); height: 300px; overflow: scroll;">
							<p:dataTable
								styleClass="fs-table no-border"
								value="#{docsController.fileSystems}"
								var="fs"
								emptyMessage="No file systems were found."
								style="width: 100%;"
								tableStyle="width: auto;">
								
								<f:facet name="header">
							        File Systems (above 16 GiB)
							    </f:facet>
							    
							    <p:column
									headerText="Name"
									styleClass="no-wrap">
									<p:outputLabel value="#{fs.name}"/>
								</p:column>
								
								<p:column
									headerText="Type"
									styleClass="no-wrap">
									<p:outputLabel value="#{fs.type}"/>
								</p:column>
								
								<p:column
									headerText="Usage"
									style="width: 99%;">
									<p:progressBar value="#{fs.usage}" labelTemplate="{value}%" displayOnly="true"/>
								</p:column>
								
								<p:column
									headerText="Free"
									styleClass="no-wrap">
									<p:outputLabel value="#{fs.free}"/>
								</p:column>
								
								<p:column
									headerText="Total"
									styleClass="no-wrap">
									<p:outputLabel value="#{fs.total}"/>
								</p:column>
							    
						    </p:dataTable>
						
							<p:dataTable
								styleClass="task-table no-border"
								value="#{tasksController.assignedTasks}"
								var="task"
								emptyMessage="You have no active tasks at the moment."
								style="width: 100%;"
								tableStyle="width: auto;">
								
								<f:facet name="header">
							        Your Active Tasks
							    </f:facet>
								
								<p:column
									headerText="ID"
									styleClass="no-wrap">
									<p:outputLabel value="#{task.id}"/>
								</p:column>
				
								<p:column
									headerText="Name"
									styleClass="no-wrap">
									<p:outputLabel value="#{task.name}"/>
								</p:column>
								
								<p:column
									headerText="Workflow"
									styleClass="no-wrap">
									<p:outputLabel value="#{task.workflowName}, #{task.workflowStateName}"/>
								</p:column>
								
								<p:column
									headerText="Priority"
									styleClass="no-wrap">
									<p:outputPanel>
										<p:outputLabel styleClass="#{task.priority.icon}" style="color: #{task.priority.color}; width: 12px; margin-right: 5px;"/>
										<p:outputLabel value="#{task.priority.name}"/>
									</p:outputPanel>
								</p:column>
								
								<p:column
									headerText="Status"
									styleClass="no-wrap">
									<p:outputLabel value="#{task.statusText}" style="color: #{task.statusColor}"/>
								</p:column>
								
								<p:column
									style="width: 99%;">
								</p:column>
								
								<p:column
									headerText="Options"
									styleClass="no-wrap"
									style="text-align: center;">
									<p:commandButton
										icon="ui-icon-arrow-4-diag"
										disabled="#{!tasksController.canViewAssignedTasks()}"
										actionListener="#{tasksController.setWorkflowTask(task, true)}"
										onclick="PF('dialogAddWorkflowTask').show();"
						            	update=":addWorkflowTaskDialogForm"
						            	style="height: 18px;"/>
					            	<p:commandButton
										icon="ui-icon-trash"
										disabled="#{!tasksController.canDeleteAssignedTasks()}"
										actionListener="#{tasksController.deleteWorkflowTask(task)}"
						            	update=":mainForm"
										oncomplete="resizeEditor();"
										style="height: 18px;">
										<p:confirm header="Confirm" message="Delete Workflow Task &lt;#{task.name}&gt; permanently?" icon="ui-icon-alert"/>
									</p:commandButton>
								</p:column>
								
							</p:dataTable>
							
							<p:outputPanel styleClass="navigation">
								<c:forEach items="#{docsController.selectedNode.children}" var="node" varStatus="loop">
									<p:outputPanel>
										<p:commandButton
											value="#{node.data.name}"
											icon="#{node.data.type.icon}"
											actionListener="#{docsController.selectNavigationItem(node)}"
											onstart="saveScrollPos();"
											update=":documentMenuForm :mainForm"
											oncomplete="resizeTreePanel(); resizeEditor(); loadScrollPos();"
											styleClass="navigation-item #{node.data.type.id}"/>
										<h:outputLink
						        			styleClass="new-tab"
						        			value="#{docsController.getDocumentLink(node)}"
						        			target="_blank"
						        			onclick="event.stopPropagation();">
						        			&#x1F5D7;
						        		</h:outputLink>
									</p:outputPanel>
								</c:forEach>
							</p:outputPanel>
						</p:scrollPanel>
						
					</p:outputPanel>
					
					<p:outputPanel rendered="#{docsController.showNavigator()}">
					
						<p:outputPanel id="navigatorHeader" styleClass="editor-header">
							<h2 class="no-spacing">#{docsController.selectedNode}</h2>
							<p class="no-spacing" style="color: #888888;">
								<b style="font-weight: 800;">#{docsController.selectedNode.childCount}</b> Documents
							</p>
							<p:breadCrumb model="#{docsController.breadcrumbModel}" homeDisplay="text"/>
						</p:outputPanel>
						<p:scrollPanel
							id="navigatorPanel"
							mode="native"
							styleClass="gray-bg"
							style="width: calc(100% - 2px); height: 300px; overflow: scroll;">
							<p:outputPanel styleClass="navigation">
								<c:forEach items="#{docsController.selectedNode.children}" var="node" varStatus="loop">
									<p:outputPanel>
										<p:commandButton
											value="#{node.data.name}"
											icon="#{node.data.type.icon}"
											actionListener="#{docsController.selectNavigationItem(node)}"
											onstart="saveScrollPos();"
											update=":documentMenuForm :mainForm"
											oncomplete="resizeTreePanel(); resizeEditor(); loadScrollPos();"
											styleClass="navigation-item #{node.data.type.id}"/>
										<h:outputLink
						        			styleClass="new-tab"
						        			value="#{docsController.getDocumentLink(node)}"
						        			target="_blank"
						        			onclick="event.stopPropagation();">
						        			&#x1F5D7;
						        		</h:outputLink>
									</p:outputPanel>
								</c:forEach>
							</p:outputPanel>
						</p:scrollPanel>
						
					</p:outputPanel>

					<p:outputPanel rendered="#{docsController.showEditor()}">

						<c:choose>
							<c:when test="#{docsController.canViewDocuments()}">
								<p:outputPanel id="editor">
									<p:textEditor
										id="editorOpen"
										widgetVar="textEditorOpen"
										value="#{docsController.content}"
										readonly="false"
										secure="false"
										rendered="#{docsController.allowEditing}"
										height="300"
										styleClass="text-editor">
										<script type="text/javascript">
											setTimeout(bindSaveKey, 250);
										</script>
										<p:remoteCommand
					            			name="saveDocument"
					            			actionListener="#{docsController.saveDocument(false)}"/>
									</p:textEditor>
									
									<p:textEditor
										id="editorClosed"
										widgetVar="textEditorClosed"
										value="#{docsController.formattedContent}"
										readonly="true"
										secure="false"
										rendered="#{!docsController.allowEditing}"
										height="300"
										styleClass="text-editor">
										<f:facet name="toolbar">
											<h2 class="no-spacing">#{docsController.selectedNode}</h2>
											<p class="no-spacing" style="color: #888888;">
												<b style="font-weight: 800;">#{docsController.selectedNode.wordCount}</b> Words,
												Last saved by <b style="font-weight: 800;">#{docsController.selectedNode.user}</b>
												at <b style="font-weight: 800;">#{docsController.selectedNode.date}</b>
											</p>
											<p:breadCrumb model="#{docsController.breadcrumbModel}" homeDisplay="text"/>
										</f:facet>
									</p:textEditor>
								</p:outputPanel>
							</c:when>
							<c:otherwise>
								<p style="font-size: 14px; margin: 10px;">
									You have no permission to view this page!<br/>
									If you think this is a mistake, please contact your administrator.
								</p>
							</c:otherwise>
						</c:choose>
						
					</p:outputPanel>
					
					<p:outputPanel rendered="#{docsController.showWorkflow()}">
					
						<c:choose>
							<c:when test="#{docsController.canViewWorkflows()}">
								<p:outputPanel id="workflowHeader" styleClass="editor-header">
									<h2 class="no-spacing">#{docsController.selectedNode}</h2>
									<p class="no-spacing" style="color: #888888;">
										<b style="font-weight: 800;">#{tasksController.workflow.taskCount}</b> Active Tasks,
										Completed Tasks will become Inactive / Hidden after 14 Days
									</p>
									<p:breadCrumb model="#{docsController.breadcrumbModel}" homeDisplay="text"/>
								</p:outputPanel>
								<p:scrollPanel
									id="workflowPanel"
									mode="native"
									styleClass="gray-bg"
									style="width: calc(100% - 2px); height: 300px; padding-top: 5px; padding-bottom: 5px; overflow: scroll;">
									<p:dashboard model="#{tasksController.model}" styleClass="project-board project-board-header">
										<c:forEach items="#{tasksController.workflow.states}" var="state">
											<p:panel id="state#{state.id}" styleClass="project-board-title">
												#{state.name}
												<br/><br/>
												<p:commandButton
													icon="ui-icon-arrowthick-1-w"
													rendered="#{docsController.canEditWorkflows()}"
													disabled="#{!tasksController.canWorkflowStateMove(state, true)}"
													actionListener="#{tasksController.moveWorkflowState(state, true)}"
									            	update=":mainForm"
													oncomplete="resizeEditor();"/>
								            	<p:commandButton
													icon="ui-icon-arrowthick-1-e"
													rendered="#{docsController.canEditWorkflows()}"
													disabled="#{!tasksController.canWorkflowStateMove(state, false)}"
													actionListener="#{tasksController.moveWorkflowState(state, false)}"
									            	update=":mainForm"
													oncomplete="resizeEditor();"/>
												<p:commandButton
													icon="ui-icon-pencil"
													rendered="#{docsController.canEditWorkflows()}"
													disabled="#{state.isBacklog() || state.isCompleted()}"
													actionListener="#{tasksController.setWorkflowState(state)}"
													onclick="PF('dialogAddWorkflowState').show();"
									            	update=":addWorkflowStateDialogForm"/>
								            	<p:commandButton
													icon="ui-icon-trash"
													rendered="#{docsController.canEditWorkflows()}"
													disabled="#{state.isBacklog() || state.isCompleted()}"
													actionListener="#{tasksController.deleteWorkflowState(state)}"
									            	update=":mainForm"
													oncomplete="resizeEditor();">
													<p:confirm header="Confirm" message="Delete Workflow State &lt;#{state.name}&gt; permanently?" icon="ui-icon-alert"/>
												</p:commandButton>
											</p:panel>
										</c:forEach>
									</p:dashboard>
									<br/>
									<p:dashboard model="#{tasksController.model}" disabled="#{!tasksController.canEditTasks()}" styleClass="project-board">
										<p:ajax
											event="reorder"
											listener="#{tasksController.handleWorkflowTaskReorder}"
											update=":mainForm"
											oncomplete="resizeEditor();"/>
										<c:forEach items="#{tasksController.workflow.tasks}" var="task">
											<p:panel
												id="task#{task.id}" styleClass="no-padding gray-bg-dark">
												<f:facet name="header">
													##{task.id} #{task.name}
												</f:facet>
												<h:panelGrid
													columns="2"
													columnClasses="left-align fifty-percent, right-align fifty-percent"
													style="width: 100%; padding: 3px;">
													<p:outputPanel>
														<p:outputLabel styleClass="#{task.priority.icon}" style="color: #{task.priority.color}; width: 12px; margin-right: 5px;"/>
														<p:outputLabel value="#{task.priority.name}"/>
													</p:outputPanel>
													<p:outputLabel value="#{task.assignedUserName}"/>
													<p:outputPanel>
														<p:commandButton
															icon="ui-icon-arrow-4-diag"
															disabled="#{!tasksController.canViewTasks()}"
															actionListener="#{tasksController.setWorkflowTask(task, false)}"
															onclick="PF('dialogAddWorkflowTask').show();"
											            	update=":addWorkflowTaskDialogForm"
											            	style="height: 18px;"/>
										            	<p:commandButton
															icon="ui-icon-trash"
															disabled="#{!tasksController.canDeleteTasks()}"
															actionListener="#{tasksController.deleteWorkflowTask(task)}"
											            	update=":mainForm"
															oncomplete="resizeEditor();"
															style="height: 18px;">
															<p:confirm header="Confirm" message="Delete Workflow Task &lt;#{task.name}&gt; permanently?" icon="ui-icon-alert"/>
														</p:commandButton>
													</p:outputPanel>
													<p:outputLabel value="#{task.statusText}" style="color: #{task.statusColor}"/>
												</h:panelGrid>
											</p:panel>
										</c:forEach>
									</p:dashboard>
								</p:scrollPanel>
							</c:when>
							<c:otherwise>
								<p style="font-size: 14px; margin: 10px;">
									You have no permission to view this page!<br/>
									If you think this is a mistake, please contact your administrator.
								</p>
							</c:otherwise>
						</c:choose>
						
					</p:outputPanel>
					
					<p:outputPanel
						id="buttonBar"
						rendered="#{docsController.showButtonBar()}"
						style="box-sizing: border-box; border: 1px solid #444444; border-top: 0; margin: 0; padding: 3px;">
						
						<p:commandButton
							id="buttonCopyLink"
							value="Copy Link"
							icon="ui-icon-copy"
							oncomplete="sendCopyLinkMessage()"
							update="@this"
							style="height: 25px; margin-right: 3px;"/>
							
						<p:commandButton
							id="buttonNewTask"
							value="New Task"
							icon="ui-icon-plus"
							rendered="#{docsController.showWorkflow()}"
							disabled="#{!tasksController.canViewTasks() || !tasksController.canEditTasks()}"
							actionListener="#{tasksController.setNewWorkflowTask()}"
							onclick="PF('dialogAddWorkflowTask').show();"
			            	update=":addWorkflowTaskDialogForm"
			            	style="height: 25px; margin-right: 3px;"/>
							
						<p:commandButton
							id="buttonNewState"
							value="New Workflow State"
							icon="ui-icon-plus"
							rendered="#{docsController.showWorkflow()}"
							disabled="#{!docsController.canEditWorkflows()}"
							actionListener="#{tasksController.setNewWorkflowState()}"
							onclick="PF('dialogAddWorkflowState').show();"
			            	update=":addWorkflowStateDialogForm"
			            	style="height: 25px; margin-right: 3px;"/>
			            	
			            <p:commandButton
							id="buttonExport"
							value="Export"
							icon="ui-icon-arrowthick-1-s"
							rendered="#{docsController.showEditor()}"
							disabled="#{docsController.allowEditing}"
							onclick="PrimeFaces.monitorDownload(start, stop);"
							style="height: 25px; margin-right: 3px;">
							<p:fileDownload value="#{docsController.exportDocument()}"/>
						</p:commandButton>
							
						<p:commandButton
							id="buttonEdit"
							value="Edit"
							icon="ui-icon-pencil"
							rendered="#{docsController.showEditor()}"
							disabled="#{docsController.allowEditing || !docsController.canEditDocuments()}"
							actionListener="#{docsController.setAllowEditing(true)}"
							oncomplete="setConfirmUnload(true); updateAll();"
							style="height: 25px; margin-right: 3px;"/>
							
						<p:chips
							id="chipsInput"
							value="#{docsController.tags}"
							placeholder="Search Tags"
							rendered="#{docsController.showEditor()}"
							disabled="#{!docsController.allowEditing}"
							onkeyup="resizeEditor();"
							style="width: 320px;  margin-right: 5px; margin-top: -9px; top: 9px; color: #ffffff;"
							styleClass="search-container">
							<p:ajax event="itemUnselect" oncomplete="resizeEditor();"/>
						</p:chips>
					
						<p:commandButton
							id="buttonQuickSave"
							value="Quick Save"
							icon="ui-icon-disk"
							rendered="#{docsController.showEditor()}"
							disabled="#{!docsController.allowEditing}"
							actionListener="#{docsController.saveDocument(false)}"
							style="height: 25px; margin-right: 3px;"/>
							
						<p:commandButton
							id="buttonSave"
							value="Save and Close"
							icon="ui-icon-disk"
							rendered="#{docsController.showEditor()}"
							disabled="#{!docsController.allowEditing}"
							actionListener="#{docsController.saveDocument(true)}"
							oncomplete="setConfirmUnload(false); updateAll();"
							style="height: 25px; margin-right: 3px;"/>
							
						<p:commandButton
							id="buttonCancel"
							value="Cancel"
							icon="ui-icon-close"
							rendered="#{docsController.showEditor()}"
							disabled="#{!docsController.allowEditing}"
							actionListener="#{docsController.setAllowEditing(false)}"
							oncomplete="setConfirmUnload(false); updateAll();"
							style="height: 25px;">
							<p:confirm
								header="Confirm"
								message="Cancel Editing? Unsaved Changes will be lost!"
								icon="ui-icon-alert"/>
						</p:commandButton>
						
			            <pe:clipboard
			            	id="clipCopy"
			            	trigger="buttonCopyLink"
			            	action="copy"
			            	text="#{docsController.getDocumentLink()}"/>
			            <p:remoteCommand
			            	name="sendCopyLinkMessage"
			            	actionListener="#{docsController.showInfoMessage('Link copied to Clipboard!')}"/>
			            	
					</p:outputPanel>

				</h:form>
				
			</p:layoutUnit>

		</p:layout>
		
		<p:dialog
			header="New Folder"
			widgetVar="dialogAddDirectory"
			showEffect="fade" hideEffect="fade"
			resizable="false"
			draggable="false"
			modal="true"
			appendTo="@(body)">
			<h:form id="addDirectoryDialogForm">
				<h:panelGrid id="addDirectoryDialogGrid" columns="2">
					<p:outputLabel value="Name: "/>
					<p:inputText value="#{docsController.name}"/>
				</h:panelGrid>
				<p:commandButton
					icon="ui-icon-disk"
					value="Save"
					actionListener="#{docsController.addDirectoryNode}"
					update=":documentMenuForm :mainForm"
					onstart="saveScrollPos()"
					oncomplete="PF('dialogAddDirectory').hide(); resizeEditor(); resizeTreePanel(); loadScrollPos();"
					style="margin-left: 3px;"/>
			</h:form>
		</p:dialog>

		<p:dialog
			header="Rename Folder"
			widgetVar="dialogRenameDirectory"
			showEffect="fade" hideEffect="fade"
			resizable="false"
			draggable="false"
			modal="true"
			appendTo="@(body)">
			<h:form id="renameDirectoryDialogForm">
				<h:panelGrid id="renameDirectoryDialogGrid" columns="2">
					<p:outputLabel value="Name: "/>
					<p:inputText value="#{docsController.name}"/>
				</h:panelGrid>
				<p:commandButton
					icon="ui-icon-refresh"
					value="Rename"
					actionListener="#{docsController.renameDirectoryNode}"
					update=":documentMenuForm :mainForm"
					onstart="saveScrollPos()"
					oncomplete="PF('dialogRenameDirectory').hide(); resizeEditor(); resizeTreePanel(); loadScrollPos();"
					style="margin-left: 3px;"/>
			</h:form>
		</p:dialog>

		<p:dialog
			header="New Element"
			widgetVar="dialogAddDocument"
			showEffect="fade" hideEffect="fade"
			resizable="false"
			draggable="false"
			modal="true"
			appendTo="@(body)">
			<h:form id="addDocumentDialogForm">
				<h:panelGrid id="addDocumentDialogGrid" columns="2">
					<p:outputLabel value="Name: "/>
					<p:inputText value="#{docsController.name}"/>
				</h:panelGrid>
				<p:commandButton
					icon="ui-icon-disk"
					value="Save"
					actionListener="#{docsController.addDocumentNode}"
					update=":documentMenuForm :mainForm"
					onstart="saveScrollPos()"
					oncomplete="PF('dialogAddDocument').hide(); resizeEditor(); resizeTreePanel(); loadScrollPos();"
					style="margin-left: 3px;"/>
			</h:form>
		</p:dialog>
		
		<p:dialog
			header="Copy Document"
			widgetVar="dialogCopyDocument"
			showEffect="fade" hideEffect="fade"
			resizable="false"
			draggable="false"
			modal="true"
			appendTo="@(body)">
			<h:form id="copyDocumentDialogForm">
				<h:panelGrid id="copyDocumentDialogGrid" columns="2">
					<p:outputLabel value="Name: "/>
					<p:inputText value="#{docsController.name}"/>
				</h:panelGrid>
				<p:commandButton
					icon="ui-icon-copy"
					value="Copy"
					actionListener="#{docsController.copyDocumentNode}"
					update=":documentMenuForm :mainForm"
					onstart="saveScrollPos()"
					oncomplete="PF('dialogCopyDocument').hide(); resizeEditor(); resizeTreePanel(); loadScrollPos();"
					style="margin-left: 3px;"/>
			</h:form>
		</p:dialog>

		<p:dialog
			header="Rename Element"
			widgetVar="dialogRenameDocument"
			showEffect="fade" hideEffect="fade"
			resizable="false"
			draggable="false"
			modal="true"
			appendTo="@(body)">
			<h:form id="renameDocumentDialogForm">
				<h:panelGrid id="renameDocumentDialogGrid" columns="2">
					<p:outputLabel value="Name: "/>
					<p:inputText value="#{docsController.name}"/>
				</h:panelGrid>
				<p:commandButton
					icon="ui-icon-refresh"
					value="Rename"
					actionListener="#{docsController.renameDocumentNode}"
					update=":documentMenuForm :mainForm"
					onstart="saveScrollPos()"
					oncomplete="PF('dialogRenameDocument').hide(); resizeEditor(); resizeTreePanel(); loadScrollPos();"
					style="margin-left: 3px;"/>
			</h:form>
		</p:dialog>
		
		<p:dialog
			header="Workflow Task"
			widgetVar="dialogAddWorkflowTask"
			showEffect="fade" hideEffect="fade"
			resizable="false"
			draggable="false"
			modal="true"
			width="900"
			height="500"
			appendTo="@(body)"
			styleClass="gray-bg">
			<p:ajax event="open" update=":addWorkflowTaskDialogForm" oncomplete="setConfirmUnload(true);"/>
			<p:ajax event="close" oncomplete="setConfirmUnload(false);"/>
			<h:form id="addWorkflowTaskDialogForm">
				<h:panelGrid
					id="addWorkflowTaskDialogGrid"
					columns="2"
					columnClasses="align-top sixty-percent, align-top fourty-percent">
					
					<p:outputLabel value="Name: "/>
					<p:outputLabel/>
					<p:inputText
						value="#{tasksController.workflowTask.name}"
						disabled="#{!tasksController.allowEditing}"
						style="width: 510px; margin-bottom: 10px;"/>
					<p:outputLabel/>
					<p:outputLabel value="Description: "/>
					<p:outputLabel/>
					<p:textEditor
						value="#{tasksController.workflowTask.description}"
						toolbarVisible="#{tasksController.allowEditing}"
						readonly="#{!tasksController.allowEditing}"
						secure="false"
						height="#{tasksController.allowEditing ? '314' : '392'}"
						styleClass="text-editor"/>
					
					<h:panelGrid columns="3">
						<p:outputLabel styleClass="fa fa-user"/>
						<p:outputLabel value="Assignee: "/>
						<p:selectOneMenu
							value="#{tasksController.workflowTask.assignedUserId}"
							disabled="#{!tasksController.allowEditing}"
							style="width: 180px;">
							<f:selectItem itemLabel="Not Assigned" itemValue="#{null}"/>
							<f:selectItems
								value="#{userController.usersAlphabetically}"
								var="user"
								itemLabel="#{user.username}"
								itemValue="#{user.id}"/>
				        </p:selectOneMenu>
				        <p:outputLabel styleClass="fa fa-warning"/>
						<p:outputLabel value="Priority: "/>
						<p:selectOneMenu
							value="#{tasksController.workflowTask.priority}"
							disabled="#{!tasksController.allowEditing}"
							style="width: 180px;">
							<f:selectItems
								value="#{tasksController.priorities}"
								var="priority"
								itemLabelEscaped="false"
								itemLabel="&lt;p:outputLabel class=&quot;#{priority.icon}&quot; style=&quot;color: #{priority.color}; width: 12px; margin-right: 5px;&quot;/&gt; #{priority.name}"
								itemValue="#{priority}"/>
				        </p:selectOneMenu>
				        <p:outputLabel styleClass="fa fa-share-alt"/>
				        <p:outputLabel value="Workflow State: "/>
						<p:selectOneMenu
							value="#{tasksController.workflowTask.workflowStateId}"
							disabled="#{!tasksController.allowEditing}"
							style="width: 180px;">
							<f:selectItems
								value="#{tasksController.workflow.states}"
								var="state"
								itemLabel="#{state.name}"
								itemValue="#{state.id}"/>
				        </p:selectOneMenu>
				        <p:outputLabel styleClass="fa fa-minus-circle"/>
						<p:outputLabel value="Deadline Date: "/>
						<p:datePicker
							value="#{tasksController.workflowTask.deadlineDate}"
							pattern="yyyy.MM.dd"
							disabled="#{!tasksController.allowEditing}"/>
						<p:outputLabel styleClass="fa fa-check-circle"/>
						<p:outputLabel value="Completion Date: "/>
						<p:datePicker
							value="#{tasksController.workflowTask.completionDate}"
							pattern="yyyy.MM.dd"
							disabled="true"/>
						<p:separator style="width: 2750%;"/>
						<p:outputLabel/>
						<p:outputLabel/>
						<p:outputLabel styleClass="fa fa-user"/>
						<p:outputLabel value="Creator: "/>
		            	<p:inputText
		            		value="#{tasksController.workflowTask.authorUser.username}"
		            		disabled="true"
		            		style="width: 180px;"/>
		            	<p:outputLabel styleClass="fa fa-plus-circle"/>
						<p:outputLabel value="Creation Date: "/>
						<p:datePicker
							value="#{tasksController.workflowTask.creationDate}"
							pattern="yyyy.MM.dd"
							disabled="true"/>
						<p:outputLabel styleClass="fa fa-chevron-circle-right"/>
						<p:outputLabel value="Last Edit Date: "/>
						<p:datePicker
							value="#{tasksController.workflowTask.editDate}"
							pattern="yyyy.MM.dd"
							disabled="true"/>
					</h:panelGrid>
					
				</h:panelGrid>
				<p:commandButton
					value="Edit"
					icon="ui-icon-pencil"
					rendered="#{tasksController.workflowTask.id != null}"
					disabled="#{tasksController.allowEditing || !tasksController.allowToggleEditing}"
					actionListener="#{tasksController.setAllowEditing(true)}"
					update=":addWorkflowTaskDialogForm"
					style="height: 25px; margin-left: 3px;"/>
				<p:commandButton
					value="Quick Save"
					icon="ui-icon-disk"
					rendered="#{tasksController.workflowTask.id != null}"
					disabled="#{!tasksController.allowEditing}"
					actionListener="#{tasksController.saveWorkflowTask(false)}"
					update=":mainForm :addWorkflowTaskDialogForm"
					oncomplete="resizeEditor();"
					style="height: 25px; margin-left: 3px;"/>
				<p:commandButton
					value="Save and Close"
					icon="ui-icon-disk"
					disabled="#{!tasksController.allowEditing}"
					actionListener="#{tasksController.saveWorkflowTask(true)}"
					update=":mainForm :addWorkflowTaskDialogForm"
					oncomplete="PF('dialogAddWorkflowTask').hide(); resizeEditor();"
					style="height: 25px; margin-left: 3px;"/>
				<p:commandButton
					id="buttonCancel"
					value="Cancel"
					icon="ui-icon-close"
					rendered="#{tasksController.workflowTask.id != null}"
					disabled="#{!tasksController.allowEditing}"
					actionListener="#{tasksController.setAllowEditing(false)}"
					update=":addWorkflowTaskDialogForm"
					process="@this"
					style="height: 25px; margin-left: 3px;">
					<p:confirm
						header="Confirm"
						message="Cancel Editing? Unsaved Changes will be lost!"
						icon="ui-icon-alert"/>
				</p:commandButton>
			</h:form>
		</p:dialog>
		
		<p:dialog
			header="#{tasksController.workflowState.isTransient() ? 'New' : 'Rename'} Workflow State"
			widgetVar="dialogAddWorkflowState"
			showEffect="fade" hideEffect="fade"
			resizable="false"
			draggable="false"
			modal="true"
			appendTo="@(body)">
			<h:form id="addWorkflowStateDialogForm">
				<h:panelGrid id="addWorkflowStateDialogGrid" columns="2">
					<p:outputLabel value="Name: "/>
					<p:inputText value="#{tasksController.workflowState.name}"/>
				</h:panelGrid>
				<p:commandButton
					icon="#{tasksController.workflowState.isTransient() ? 'ui-icon-disk' : 'ui-icon-refresh'}"
					value="#{tasksController.workflowState.isTransient() ? 'Save' : 'Rename'}"
					actionListener="#{tasksController.saveWorkflowState()}"
					update=":mainForm"
					oncomplete="PF('dialogAddWorkflowState').hide(); resizeEditor();"
					style="margin-left: 3px;"/>
			</h:form>
		</p:dialog>
		
    </ui:define>
    
</ui:composition>