<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui"
    xmlns:pe="http://primefaces.org/ui/extensions"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
    xmlns:s="http://java.sun.com/jsf/composite/components/shared"
	xmlns:tw="http://java.sun.com/jsf/composite/components/tasks"
    template="/templates/default.xhtml" >

    <ui:define name="center">

		<script type="text/javascript">
		
			function saveScrollPos() {
				sessionStorage.scrollTop = $('#documentMenuForm\\:treePanel').scrollTop();
			}

			function loadScrollPos() {
				$('#documentMenuForm\\:treePanel').scrollTop(sessionStorage.scrollTop);
			}

			function searchKeyPress(e) {
			    if (e.keyCode == 13) {
			        updateTree();
			    }
			}
			
			function bindSaveKey() {
				$('.ql-editor').keydown(function (e) {
				    if (e.keyCode == 83 &amp;&amp; event.ctrlKey) {
			        	e.preventDefault();
			        	saveDocument();
				    }
				});
			}

			$(document).ready(function () {
				setTimeout(resizeTreePanel, 250);
				setTimeout(resizeEditor, 250);
			});

			$(window).on('resize', function() {
				setTimeout(resizeTreePanel, 250);
				setTimeout(resizeEditor, 250);
			});

			function resizeTreePanel() {
				var searchHeight = $("#documentMenuForm\\:searchTags > .ui-chips-container").height();
				$("#documentMenuForm\\:treePanel").height($(document).height() - 68 - searchHeight);
			}
			
			function resizeEditor() {
				$("#mainForm\\:workflowPanel").height($(document).height() - 50);
				
				var buttonBarHeight = $("#mainForm\\:buttonBar").height();
				var newHeight = $(document).height() - buttonBarHeight - 43;
				var isChromium = window.chrome;

				var openToolbar = $("#mainForm\\:editorOpen_toolbar");
				var openToolbarHeight = openToolbar.outerHeight();
				$("#mainForm\\:editorOpen_editor").height(newHeight - openToolbarHeight);

				var closedToolbar = $("#mainForm\\:editorClosed_toolbar");
				var closedToolbarHeight = closedToolbar.outerHeight();
				$("#mainForm\\:editorClosed_editor").height(newHeight - closedToolbarHeight);
			}
			
		</script>
		
		<style>
		
			.fa-th-large {
				color: plum;
			}
		
			.fa-folder-open {
				color: moccasin;
			}
			
			.fa-file {
				color: skyblue;
			}
			
			.fa-share-alt {
				color: lightsalmon;
			}
		
		</style>

		<p:layout>
		
			<p:layoutUnit
				id="layoutUnitWest"
				position="west"
				gutter="0"
				size="360"
				styleClass="no-border no-overflow gray-bg"
				style="padding: 3px;">

				<h:form id="documentMenuForm">

					<p:chips
						id="searchTags"
						value="#{docsController.searchTags}"
						placeholder="Search for Document Names or Tags..."
						disabled="#{docsController.allowEditing}"
						onkeyup="searchKeyPress(event)"
						styleClass="search-container"
						style="width: calc(100% - 2px); height: 23px; color: #ffffff;">
						<p:ajax event="itemUnselect" oncomplete="updateTree()"/>
					</p:chips>
					<p:selectBooleanButton
						id="buttonToggleSort"
						value="#{docsController.allowSorting}"
						disabled="#{docsController.allowEditing}"
						onLabel="Leave Sort Mode"
						offLabel="Enter Sort Mode"
						onIcon="ui-icon-close"
						offIcon="ui-icon-caret-2-n-s"
						style="width: 132px; height: 21px; margin: 0;">
						<p:ajax update="documentTree" oncomplete="resizeTreePanel();" />
					</p:selectBooleanButton>
		        	<p:commandButton
		        		id="buttonRefresh"
			        	value="Refresh"
			        	icon="ui-icon-arrowrefresh-1-e"
			        	disabled="#{docsController.allowEditing}"
			        	actionListener="#{docsController.selectTree}"
			        	update=":documentMenuForm,:mainForm"
			        	oncomplete="resizeTreePanel()"
			        	style="width: 110px; height: 23px; margin: 0;"/>
					<p:commandButton
						id="buttonSearch"
						value="Search"
			        	icon="ui-icon-search"
						disabled="#{docsController.allowEditing}"
						onclick="updateTree()"
						style="width: 110px; height: 23px; margin: 0;"/>
					<p:remoteCommand
						name="updateTree"
						actionListener="#{docsController.selectTree}"
						update="documentTree :mainForm"
						oncomplete="resizeTreePanel(); resizeEditor();"/>
					<p:remoteCommand
						name="updateAll"
						actionListener="#{docsController.selectTree}"
						update="searchTags buttonToggleSort buttonRefresh buttonSearch documentTree :mainForm"
						oncomplete="resizeTreePanel(); resizeEditor();"/>
					
					<p:scrollPanel
						id="treePanel"
						mode="native"
						styleClass="gray-bg-dark"
						style="width: calc(100% - 2px); height: 565px; overflow: scroll;">

						<p:tree
							id="documentTree"
							cache="false"
							value="#{docsController.documentTree}"
							var="node"
							styleClass="no-border inherit-tree-overflow gray-bg-dark"
							style="width: 100%; height: 100%;"
							selectionMode="single"
							selection="#{docsController.selectedNode}"
							dynamic="true"
							disabled="#{docsController.allowEditing}"
							draggable="#{docsController.allowSorting}"
							droppable="#{docsController.allowSorting}">
	
					        <p:treeNode
					        	id="rootNode"
					        	type="rootNode">
					        	<h:panelGrid
					        		columns="4">
					            	<p:outputLabel styleClass="fa fa-th-large" />
					            	<h:outputText value="#{node}" />
					        	</h:panelGrid>
					        </p:treeNode>
	
					        <p:treeNode
					        	id="directoryNode"
					        	type="directoryNode">
					        	<h:panelGrid
					        		columns="2">
					            	<p:outputLabel styleClass="fa fa-folder-open" />
					            	<h:outputText value="#{node}" />
					        	</h:panelGrid>
					        </p:treeNode>
	
					        <p:treeNode
					        	id="documentNode"
					        	type="documentNode">
					        	<h:panelGrid
					        		columns="2">
					            	<p:outputLabel styleClass="fa fa-file" />
					            	<h:outputText value="#{node}" />
					        	</h:panelGrid>
					        </p:treeNode>
					        
					        <p:treeNode
					        	id="workflowNode"
					        	type="workflowNode">
					        	<h:panelGrid
					        		columns="2">
					            	<p:outputLabel styleClass="fa fa-share-alt" />
					            	<h:outputText value="#{node}" />
					        	</h:panelGrid>
					        </p:treeNode>
	
					        <p:ajax event="select" update=":mainForm" oncomplete="resizeEditor()"/>
					        <p:ajax event="contextMenu" update=":mainForm" oncomplete="resizeEditor()"/>
					        <p:ajax event="dragdrop" listener="#{docsController.onDragDrop}" update=":documentMenuForm" oncomplete="resizeTreePanel();"/>
						    <p:ajax event="expand" listener="#{docsController.onNodeExpand}"/>
							<p:ajax event="collapse" listener="#{docsController.onNodeCollapse}"/>
					    </p:tree>
				    
				    </p:scrollPanel>

					<p:contextMenu for="documentTree" nodeType="rootNode">
			            <p:menuitem
			            	value="Collapse All"
			            	icon="fa fa-folder"
			            	actionListener="#{docsController.collapseAll()}"
			            	update="documentTree :mainForm"/>
			            <p:menuitem
			            	value="New Folder"
			            	icon="fa fa-folder-open"
			            	actionListener="#{docsController.setName('New Folder')}"
			            	onclick="PF('dialogAddDirectory').show();"
			            	update=":addDirectoryDialogForm"/>
			            <p:menuitem
			            	value="New Document"
			            	icon="fa fa-file"
			            	actionListener="#{docsController.setName('New Document')}"
			            	onclick="PF('dialogAddDocument').show();"
			            	update=":addDocumentDialogForm"/>
		            	<p:menuitem
			            	value="New Workflow"
			            	icon="fa fa-share-alt"
			            	actionListener="#{docsController.setName('New Workflow', 'workflowNode')}"
			            	onclick="PF('dialogAddDocument').show();"
			            	update=":addDocumentDialogForm"/>
				    </p:contextMenu>

					<p:contextMenu for="documentTree" nodeType="directoryNode">
						<p:menuitem
							value="Collapse All"
							icon="fa fa-folder"
							actionListener="#{docsController.collapseRecursive(docsController.selectedNode)}"
							update="documentTree :mainForm"/>
			            <p:menuitem
			            	value="New Folder"
			            	icon="fa fa-folder-open"
			            	actionListener="#{docsController.setName('New Folder')}"
			            	onclick="PF('dialogAddDirectory').show();"
			            	update=":addDirectoryDialogForm"/>
			            <p:menuitem
			            	value="New Document"
			            	icon="fa fa-file"
			            	actionListener="#{docsController.setName('New Document', 'documentNode')}"
			            	onclick="PF('dialogAddDocument').show();"
			            	update=":addDocumentDialogForm"/>
			            <p:menuitem
			            	value="New Workflow"
			            	icon="fa fa-share-alt"
			            	actionListener="#{docsController.setName('New Workflow', 'workflowNode')}"
			            	onclick="PF('dialogAddDocument').show();"
			            	update=":addDocumentDialogForm"/>
	       				<p:menuitem
	       					value="Rename"
	       					icon="fa fa-refresh"
	       					onclick="PF('dialogRenameDirectory').show();"
	       					update=":renameDirectoryDialogForm"/>
	       				<p:menuitem
	       					value="Delete"
	       					icon="fa fa-trash"
	       					actionListener="#{docsController.deleteFolder}"
	       					update="documentTree :mainForm">
	       					<p:confirm header="Confirm" message="Delete Folder?" icon="ui-icon-alert"/>
	       				</p:menuitem>
				    </p:contextMenu>

					<p:contextMenu for="documentTree" nodeType="documentNode">
						<p:menuitem
	       					value="Open in New Tab"
       						icon="fa fa-external-link"
	       					update="documentLinkPanel"
	       					oncomplete="openDocumentLink();"/>
	       				<p:menuitem
			            	value="Copy"
			            	icon="fa fa-copy"
			            	actionListener="#{docsController.setName(docsController.name.concat(' - Copy'))}"
			            	onclick="PF('dialogCopyDocument').show();"
			            	update=":copyDocumentDialogForm"/>
	       				<p:menuitem
	       					value="Rename"
       						icon="fa fa-refresh"
	       					onclick="PF('dialogRenameDocument').show();"
	       					update=":renameDocumentDialogForm"/>
	       				<p:menuitem
	       					value="Delete"
	       					icon="fa fa-trash"
	       					actionListener="#{docsController.deleteDocument}"
	       					update="documentTree :mainForm">
	       					<p:confirm header="Confirm" message="Delete Document?" icon="ui-icon-alert"/>
	       				</p:menuitem>
				    </p:contextMenu>
				    
				    <p:contextMenu for="documentTree" nodeType="workflowNode">
						<p:menuitem
	       					value="Open in New Tab"
       						icon="fa fa-external-link"
	       					update="documentLinkPanel"
	       					oncomplete="openDocumentLink();"/>
	       				<p:menuitem
	       					value="Rename"
       						icon="fa fa-refresh"
	       					onclick="PF('dialogRenameDocument').show();"
	       					update=":renameDocumentDialogForm"/>
	       				<p:menuitem
	       					value="Delete"
	       					icon="fa fa-trash"
	       					actionListener="#{docsController.deleteDocument}"
	       					update="documentTree :mainForm">
	       					<p:confirm header="Confirm" message="Delete Document?" icon="ui-icon-alert"/>
	       				</p:menuitem>
				    </p:contextMenu>

				</h:form>
				
				<p:panel id="documentLinkPanel">
					<script type="text/javascript">
	
						function openDocumentLink() {
							window.open('#{docsController.getDocumentLink()}', '_blank');
							window.open().close();
						}
		
					</script>
				</p:panel>

			</p:layoutUnit>

			<p:layoutUnit
				id="center"
				position="center"
				gutter="0"
				size="100%"
				styleClass="no-border no-overflow gray-bg"
				style="padding: 3px;">

				<h:form id="mainForm">
				
					<p:outputPanel rendered="#{docsController.showHelp()}">
						Placeholder
					</p:outputPanel>

					<p:outputPanel rendered="#{docsController.showEditor()}">

						<p:outputPanel id="editor">
							<p:textEditor
								id="editorOpen"
								widgetVar="textEditorOpen"
								value="#{docsController.content}"
								readonly="false"
								rendered="#{docsController.allowEditing}"
								height="500"
								styleClass="text-editor">
								<script type="text/javascript">
									setTimeout(bindSaveKey, 250);
								</script>
								<p:remoteCommand
			            			name="saveDocument"
			            			actionListener="#{docsController.saveDocument(false)}"/>
							</p:textEditor>
							
							<p:textEditor
								id="editorClosed"
								widgetVar="textEditorClosed"
								value="#{docsController.content}"
								readonly="true"
								rendered="#{!docsController.allowEditing}"
								height="500"
								styleClass="text-editor">
								<f:facet name="toolbar">
									<span class="ql-formats">
										<p:outputPanel>
											<h2 class="no-spacing">#{docsController.selectedNode}</h2>
											<p class="no-spacing" style="color: #888888;">
												Last saved by <b style="font-weight: 800;">#{docsController.selectedNode.user}</b>
												at <b style="font-weight: 800;">#{docsController.selectedNode.date}</b>
											</p>
										</p:outputPanel>
									</span>
								</f:facet>
							</p:textEditor>
						</p:outputPanel>
						
						<p:outputPanel id="buttonBar" style="box-sizing: border-box; border: 1px solid #444444; border-top: 0; padding-top: #{sessionController.isChrome() ? '3px;' : '3px;'}">
							<h:panelGrid columns="6" styleClass="no-spacing" style="margin-left: 4px !important;">
							
								<p:commandButton
									id="buttonCopyLink"
									value="Copy Link"
									icon="ui-icon-copy"
									oncomplete="sendCopyLinkMessage()"
									style="margin-right: 3px; height: 25px; top: -2px;"
									update="@this"/>
									
								<p:commandButton
									id="buttonToggleEdit"
									value="Edit"
									icon="ui-icon-pencil"
									disabled="#{docsController.allowEditing}"
									actionListener="#{docsController.setAllowEditing(true)}"
									style="margin-right: 3px; height: 25px; top: -2px;"
									oncomplete="updateAll();"/>
							
								<p:chips
									id="chipsInput"
									value="#{docsController.tags}"
									placeholder="Search Tags"
									disabled="#{!docsController.allowEditing}"
									onkeyup="resizeEditor();"
									style="margin-right: 5px; width: 320px; height: 23px; top: #{sessionController.isChrome() ? '-1px;' : '0px;'} color: #ffffff;"
									styleClass="search-container">
									<p:ajax event="itemUnselect" oncomplete="resizeEditor();"/>
								</p:chips>
									
								<p:commandButton
									id="buttonQuickSave"
									value="Quick Save"
									icon="ui-icon-disk"
									disabled="#{!docsController.allowEditing}"
									actionListener="#{docsController.saveDocument(false)}"
									style="margin-right: 3px; height: 25px; top: -2px;"/>
									
								<p:commandButton
									id="buttonSave"
									value="Save"
									icon="ui-icon-disk"
									disabled="#{!docsController.allowEditing}"
									actionListener="#{docsController.saveDocument(true)}"
									style="margin-right: 3px; height: 25px; top: -2px;"
									oncomplete="updateAll();"/>
									
								<p:commandButton
									id="buttonCancel"
									value="Cancel"
									icon="ui-icon-close"
									disabled="#{!docsController.allowEditing}"
									actionListener="#{docsController.setAllowEditing(false)}"
									style="margin-right: 3px; height: 25px; top: -2px;"
									oncomplete="updateAll();">
									<p:confirm
										header="Confirm"
										message="Cancel Editing? Unsaved Changes will be lost!"
										icon="ui-icon-alert"/>
								</p:commandButton>
									
							</h:panelGrid>
						</p:outputPanel>

			            <pe:clipboard id="clipCopy" trigger="buttonCopyLink" action="copy" text="#{docsController.getDocumentLink()}"/>
			            <p:remoteCommand
			            	name="sendCopyLinkMessage"
			            	actionListener="#{docsController.showInfoMessage('Link copied to Clipboard!')}"/>

					</p:outputPanel>
					
					<p:outputPanel rendered="#{docsController.showWorkflow()}">
						<p:scrollPanel
							id="workflowPanel"
							mode="native"
							styleClass="gray-bg"
							style="width: calc(100% - 2px); height: 565px; padding-top: 5px; padding-bottom: 5px; overflow: scroll;">
					
							<p:dashboard model="#{tasksController.model}" styleClass="project-board project-board-header">
								<c:forEach items="#{tasksController.workflow.states}" var="state">
									<p:panel id="state#{state.id}" styleClass="project-board-title">
										#{state.name}
									</p:panel>
								</c:forEach>
							</p:dashboard>
							<br/>
							<p:dashboard model="#{tasksController.model}" styleClass="project-board">
								<c:forEach items="#{tasksController.workflow.states}" var="state">
									<p:panel id="task#{state.id}" header="Task #{state.id}" >
										Test Task
									</p:panel>
								</c:forEach>
							</p:dashboard>
						
						</p:scrollPanel>
					</p:outputPanel>

				</h:form>
				
			</p:layoutUnit>

		</p:layout>
		
		<p:dialog
			header="New Folder"
			widgetVar="dialogAddDirectory"
			showEffect="fade" hideEffect="fade"
			resizable="false"
			draggable="false"
			modal="true"
			appendTo="@(body)">
			<h:form id="addDirectoryDialogForm">
				<h:panelGrid id="addDirectoryDialogGrid" columns="2">
					<p:outputLabel value="Name: "/>
					<p:inputText value="#{docsController.name}"/>
				</h:panelGrid>
				<p:commandButton
					icon="ui-icon-disk"
					value="Save"
					actionListener="#{docsController.addDirectoryNode}"
					update=":documentMenuForm :mainForm"
					onstart="saveScrollPos()"
					oncomplete="PF('dialogAddDirectory').hide(); resizeEditor(); resizeTreePanel(); loadScrollPos();"/>
			</h:form>
		</p:dialog>

		<p:dialog
			header="Rename Folder"
			widgetVar="dialogRenameDirectory"
			showEffect="fade" hideEffect="fade"
			resizable="false"
			draggable="false"
			modal="true"
			appendTo="@(body)">
			<h:form id="renameDirectoryDialogForm">
				<h:panelGrid id="renameDirectoryDialogGrid" columns="2">
					<p:outputLabel value="Name: "/>
					<p:inputText value="#{docsController.name}"/>
				</h:panelGrid>
				<p:commandButton
					icon="ui-icon-refresh"
					value="Rename"
					actionListener="#{docsController.renameDirectoryNode}"
					update=":documentMenuForm :mainForm"
					onstart="saveScrollPos()"
					oncomplete="PF('dialogRenameDirectory').hide(); resizeEditor(); resizeTreePanel(); loadScrollPos();"/>
			</h:form>
		</p:dialog>

		<p:dialog
			header="New Element"
			widgetVar="dialogAddDocument"
			showEffect="fade" hideEffect="fade"
			resizable="false"
			draggable="false"
			modal="true"
			appendTo="@(body)">
			<h:form id="addDocumentDialogForm">
				<h:panelGrid id="addDocumentDialogGrid" columns="2">
					<p:outputLabel value="Name: "/>
					<p:inputText value="#{docsController.name}"/>
				</h:panelGrid>
				<p:commandButton
					icon="ui-icon-disk"
					value="Save"
					actionListener="#{docsController.addDocumentNode}"
					update=":documentMenuForm :mainForm"
					onstart="saveScrollPos()"
					oncomplete="PF('dialogAddDocument').hide(); resizeEditor(); resizeTreePanel(); loadScrollPos();"/>
			</h:form>
		</p:dialog>
		
		<p:dialog
			header="Copy Document"
			widgetVar="dialogCopyDocument"
			showEffect="fade" hideEffect="fade"
			resizable="false"
			draggable="false"
			modal="true"
			appendTo="@(body)">
			<h:form id="copyDocumentDialogForm">
				<h:panelGrid id="copyDocumentDialogGrid" columns="2">
					<p:outputLabel value="Name: "/>
					<p:inputText value="#{docsController.name}"/>
				</h:panelGrid>
				<p:commandButton
					icon="ui-icon-copy"
					value="Copy"
					actionListener="#{docsController.copyDocumentNode}"
					update=":documentMenuForm :mainForm"
					onstart="saveScrollPos()"
					oncomplete="PF('dialogCopyDocument').hide(); resizeEditor(); resizeTreePanel(); loadScrollPos();"/>
			</h:form>
		</p:dialog>

		<p:dialog
			header="Rename Document"
			widgetVar="dialogRenameDocument"
			showEffect="fade" hideEffect="fade"
			resizable="false"
			draggable="false"
			modal="true"
			appendTo="@(body)">
			<h:form id="renameDocumentDialogForm">
				<h:panelGrid id="renameDocumentDialogGrid" columns="2">
					<p:outputLabel value="Name: "/>
					<p:inputText value="#{docsController.name}"/>
				</h:panelGrid>
				<p:commandButton
					icon="ui-icon-refresh"
					value="Rename"
					actionListener="#{docsController.renameDocumentNode}"
					update=":documentMenuForm :mainForm"
					onstart="saveScrollPos()"
					oncomplete="PF('dialogRenameDocument').hide(); resizeEditor(); resizeTreePanel(); loadScrollPos();"/>
			</h:form>
		</p:dialog>
		
    </ui:define>
    
</ui:composition>